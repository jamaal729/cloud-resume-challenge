---
- name: Deploy Azure Function App
  hosts: localhost
  connection: local
  gather_facts: false
  
  vars_files:
    - vaults/prod.yml
  
  vars:
    # resource_group: "{{ azure_resource_group }}"
    # location: "{{ azure_location }}"
    # function_app_name: "{{ azure_function_app_name }}"
    # function_storage_name: "{{ azure_function_storage_name }}"
    # cosmosdb_account_name: "{{ azure_cosmosdb_account_name }}"
    resource_group: "cloud-resume-challenge"
    location: eastus
    function_app_name: viewcounterfnapp  # 3-60 chars, lowercase, alphanumeric, hyphens
    function_storage_name: viewcounterfnstorage  # 3-24 chars, lowercase only
    cosmosdb_account_name: "viewcountercrc2025"
    
  tasks:
    - name: Build Bicep template
      ansible.builtin.command:
        cmd: az bicep build --file ./function-app.bicep --outfile ./function-app.built.json
        chdir: "{{ playbook_dir }}/.."
      changed_when: true

    - name: Deploy Function App infrastructure
      azure.azcollection.azure_rm_deployment:
        resource_group: "{{ resource_group }}"
        location: "{{ location }}"
        template: "{{ lookup('file', '../function-app.built.json') | from_json }}"
        parameters:
          location:
            value: "{{ location }}"
          functionAppName:
            value: "{{ function_app_name }}"
          storageAccountName:
            value: "{{ function_storage_name }}"
          cosmosDbAccountName:
            value: "{{ cosmosdb_account_name }}"
      register: deployment

    - name: Display deployment outputs
      ansible.builtin.debug:
        var: deployment.deployment.outputs

    - name: Create zip package for deployment
      community.general.archive:
        path:
          - "{{ playbook_dir }}/../src/function_app.py"
          - "{{ playbook_dir }}/../src/requirements.txt"
          - "{{ playbook_dir }}/../src/host.json"
        dest: "{{ playbook_dir }}/../function-app.zip"
        format: zip
      
    - name: Deploy function code
      ansible.builtin.command:
        cmd: >
          az functionapp deployment source config-zip
          --resource-group {{ resource_group }}
          --name {{ function_app_name }}
          --src {{ playbook_dir }}/../function-app.zip
      changed_when: true
      
    - name: Clean up zip file
      ansible.builtin.file:
        path: "{{ playbook_dir }}/../function-app.zip"
        state: absent